<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stalls</title>
    <link rel="stylesheet" href="../../css/styles.css" />
    <link rel="stylesheet" href="../../css/stalls.css" />
    <script src="../../js/config.js"></script>
    <script src="../../node_modules/htmx.org/dist/htmx.js"></script>
    <script src="../../js/include.js"></script>
    <script>
      htmx.logAll(); // Enable HTMX debugging
    </script>
  </head>

  <body>
    <header>
      <div id="navbar" data-include-html="../../html/navbar.html"></div>
    </header>
    <main>
      <div class="container">
        <input
          type="text"
          id="search"
          placeholder="Search for stalls"
          class="search-bar"
          hx-get="/stalls/search"
          hx-target="#stall-list"
          hx-trigger="keyup changed delay:500ms"
        />
        <button
          hx-get="/stalls/nearby"
          hx-target="#stall-list"
          hx-params="latitude longitude"
          onclick="getLocation()"
        >
          Find Nearby Stalls
        </button>
        <div
          id="stall-list"
          class="stall-grid"
          hx-get="/stalls/"
          hx-trigger="load"
          hx-target="#stall-list"
          hx-swap="innerHTML"
        >
          <!-- Stalls will be dynamically loaded here -->
        </div>
      </div>
    </main>
    <footer>
      <div id="footer" data-include-html="../../html/footer.html"></div>
    </footer>

    <script>
      // Configure HTMX to send Authorization header
      document.addEventListener("htmx:configRequest", function (event) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user && user.accessToken) {
          event.detail.headers["Authorization"] = `Bearer ${user.accessToken}`;
        }
      });

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((position) => {
            document.getElementById("latitude").value =
              position.coords.latitude;
            document.getElementById("longitude").value =
              position.coords.longitude;
          });
        }
      }

      function viewStallDetails(stallId) {
        window.location.href = `/html/stalls/stallDetails.html?id=${stallId}`;
      }

      // Navbar update logic
      function updateNavbar() {
        const navbarContainer = document.getElementById("navbar");
        const user = JSON.parse(localStorage.getItem("user"));

        if (navbarContainer) {
          const navUserNavContainer = navbarContainer.querySelector(
            "#user-nav-container"
          );
          if (navUserNavContainer) {
            let userNavContent = '<ul class="nav-items">';

            if (user && user.accessToken) {
              userNavContent += `
                            <li><a href="../../html/user/user.html">User Profile</a></li>
                            <li><a href="#" id="logout-link">Logout</a></li>
                        `;

              if (user.role === "superAdmin") {
                console.log("User is superAdmin");
                userNavContent += `
                                <li><a href="../../html/administration/admin.html">Admin</a></li>
                            `;
              }
            } else {
              userNavContent += `
                            <li><a href="../../html/auth/login.html">Login</a></li>
                            <li><a href="../../html/auth/register.html">Register</a></li>
                        `;
            }

            userNavContent += "</ul>";
            navUserNavContainer.innerHTML = userNavContent;
            console.log("userNavContent added to navbar:", userNavContent);

            const logoutLink =
              navUserNavContainer.querySelector("#logout-link");
            if (logoutLink) {
              logoutLink.addEventListener("click", () => {
                console.log("Logout link clicked");
                localStorage.removeItem("user");
                window.location.href = "../../html/auth/login.html";
              });
            }
          }
        }
      }

      // Observe the navbar for changes to trigger updateNavbar
      const observer = new MutationObserver(() => {
        const navbarElement = document.getElementById("navbar");
        if (navbarElement && navbarElement.innerHTML.trim() !== "") {
          updateNavbar();
          observer.disconnect();
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        observer.observe(document.getElementById("navbar"), {
          childList: true,
        });
      });
    </script>
  </body>
</html>
