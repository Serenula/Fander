<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stall Details</title>
    <link rel="stylesheet" href="../../css/styles.css" />
    <link rel="stylesheet" href="../../css/stallDetails.css" />
    <script src="../../js/config.js"></script>
    <script src="../../node_modules/htmx.org/dist/htmx.js"></script>
    <script src="../../js/include.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          window.location.href = "../../html/auth/login.html";
        }
      });
    </script>
  </head>

  <body class="stall-details-page">
    <div id="navbar" data-include-html="../navbar.html"></div>
    <div class="container">
      <div
        id="stall-details"
        hx-get="/api/stalls/{{stallId}}"
        hx-trigger="load"
        hx-target="#stall-details"
        hx-swap="innerHTML"
      >
        <!-- Stall details will be loaded here -->
      </div>
      <div id="thumbnail-container" class="thumbnail-container">
        <!-- Thumbnail images will be loaded here -->
      </div>
      <p class="spot-mistake-container">
        <a href="#" class="spot-mistake" onclick="reportMistake()"
          >Spot a mistake?</a
        >
      </p>
      <div class="reviews">
        <h2>Reviews</h2>
        <div
          id="reviews-list"
          hx-get="/api/reviews/{{stallId}}"
          hx-trigger="load"
          hx-target="#reviews-list"
          hx-swap="innerHTML"
        >
          <!-- Reviews will be loaded here -->
        </div>
        <button class="leave-review-btn" onclick="toggleReviewForm()">
          Leave a Review
        </button>
        <div id="review-form" style="display: none">
          <h3>Leave a Review</h3>
          <form
            id="leave-review-form"
            hx-post="/api/reviews/create"
            hx-trigger="submit"
            hx-target="#reviews-list"
            hx-swap="innerHTML"
          >
            <input
              type="hidden"
              id="stallId"
              name="stallId"
              value="{{stallId}}"
            />
            <div class="form-group">
              <label for="rating">Rating:</label>
              <input
                type="number"
                id="rating"
                name="rating"
                min="1"
                max="5"
                required
              />
            </div>
            <div class="form-group">
              <label for="comment">Comment:</label>
              <textarea id="comment" name="comment" required></textarea>
            </div>
            <div class="form-group">
              <button type="submit">Submit Review</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      function toggleReviewForm() {
        const reviewForm = document.getElementById("review-form");
        reviewForm.style.display =
          reviewForm.style.display === "none" ? "block" : "none";
      }

      function reportMistake() {
        alert("Thank you for reporting a mistake. We will look into it.");
      }

      function changeMainImage(url, thumbnailElement) {
        const mainImage = document.getElementById("main-image");
        mainImage.src = `http://127.0.0.1:5001/api${url}`;

        document.querySelectorAll(".thumbnail").forEach((thumb) => {
          thumb.classList.remove("active");
        });
        thumbnailElement.classList.add("active");
      }

      document.addEventListener("htmx:configRequest", function (event) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user && user.accessToken) {
          event.detail.headers["Authorization"] = `Bearer ${user.accessToken}`;
          event.detail.headers["x-refresh-token"] = user.refreshToken;
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const stallId = urlParams.get("id");
        if (stallId) {
          document.getElementById("stallId").value = stallId;
          document
            .getElementById("stall-details")
            .setAttribute("hx-get", `/api/stalls/${stallId}`);
          document
            .getElementById("reviews-list")
            .setAttribute("hx-get", `/api/reviews/${stallId}`);
        } else {
          console.error("No stall ID found in URL parameters");
        }
      });
    </script>

    <footer>
      <div id="footer" data-include-html="../footer.html"></div>
    </footer>
  </body>
</html>
