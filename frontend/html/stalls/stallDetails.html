<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stall Details</title>
    <link rel="stylesheet" href="../../css/stallDetails.css" />
    <link rel="stylesheet" href="../../css/styles.css"
    <script src="../../js/config.js"></script>
    <script src="../../node_modules/htmx.org/dist/htmx.js"></script>
  </head>
  <body>
    <div id="navbar"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("user"));
        let navbarContent = `
          <nav>
            <ul>
              <li><button onclick="history.back()">Back</button></li>
              <li><a href="/html/stalls/stalls.html">Stalls</a></li>
        `;

        if (user) {
          navbarContent += `
            <li><a href="/html/user/user.html">User Profile</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
          `;
          if (user.role === "superAdmin") {
            navbarContent += `
              <li><a href="/html/admin/admin.html">Admin</a></li>
            `;
          }
        } else {
          navbarContent += `
            <li><a href="/html/auth/login.html">Login</a></li>
            <li><a href="/html/auth/register.html">Register</a></li>
          `;
        }

        navbarContent += `
            </ul>
          </nav>
        `;

        document.getElementById("navbar").innerHTML = navbarContent;
      });

      function logout() {
        localStorage.removeItem("user");
        window.location.href = "/html/auth/login.html";
      }
    </script>
    <div class="container">
      <h1>Stall Details</h1>
      <div id="stall-details">
        <!-- Stall details will be loaded here -->
      </div>
      <div class="reviews">
        <h2>Reviews</h2>
        <div id="reviews-list">
          <!-- Reviews will be loaded here -->
        </div>
        <button onclick="toggleReviewForm()">Leave a Review</button>
        <div id="review-form" style="display: none">
          <h3>Leave a Review</h3>
          <form id="leave-review-form" onsubmit="submitReview(event)">
            <input type="hidden" id="stallId" name="stallId" value="" />
            <div class="form-group">
              <label for="rating">Rating:</label>
              <input
                type="number"
                id="rating"
                name="rating"
                min="1"
                max="5"
                required
              />
            </div>
            <div class="form-group">
              <label for="comment">Comment:</label>
              <textarea id="comment" name="comment" required></textarea>
            </div>
            <div class="form-group">
              <button type="submit">Submit Review</button>
            </div>
          </form>
        </div>
      </div>
      <p><a href="#" onclick="reportMistake()">Spot a mistake?</a></p>
    </div>
    <script>
      function toggleReviewForm() {
        const reviewForm = document.getElementById("review-form");
        reviewForm.style.display =
          reviewForm.style.display === "none" ? "block" : "none";
      }

      function reportMistake() {
        alert("Thank you for reporting a mistake. We will look into it.");
      }

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const stallId = urlParams.get("id");
        if (stallId) {
          document.getElementById("stallId").value = stallId;
          fetchStallDetails(stallId);
        } else {
          console.error("No stall ID found in URL parameters");
        }
      });

      function fetchStallDetails(stallId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.error("No access token found in localStorage");
          return;
        }
        fetch(`http://127.0.0.1:5001/api/stalls/${stallId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${user.accessToken}`,
          },
        })
          .then((response) => response.json())
          .then((stall) => {
            const stallDetailsDiv = document.getElementById("stall-details");
            stallDetailsDiv.innerHTML = `
            <img src="${stall.imageUrl}" alt="${
              stall.name
            }" class="stall-image">
            <p><strong>Address:</strong> <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
              stall.address
            )}" target="_blank">${stall.address}</a></p>
            <p><strong>Operating Hours:</strong> ${stall.hours}</p>
            <h3>Dishes</h3>
            <p><strong>Meat:</strong> $${stall.meat}</p>
            <p><strong>Vegetable:</strong> $${stall.vegetable}</p>
            <p><strong>Fish:</strong> $${stall.fish}</p>
            ${stall.misc ? `<p><strong>Misc:</strong> $${stall.misc}</p>` : ""}
          `;
            fetchReviews(stallId);
          })
          .catch((error) =>
            console.error("Error fetching stall details:", error)
          );
      }

      function fetchReviews(stallId) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.error("No access token found in localStorage");
          return;
        }

        fetch(`http://127.0.0.1:5001/api/reviews/${stallId}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${user.accessToken}`,
            "x-refresh-token": user.refreshToken,
          },
        })
          .then((response) => response.json())
          .then((reviews) => {
            const reviewsListDiv = document.getElementById("reviews-list");
            if (reviews.length === 0) {
              reviewsListDiv.innerHTML = "<p>No reviews</p>";
            } else {
              reviewsListDiv.innerHTML = reviews
                .map(
                  (review) => `
              <div class="review">
                <p><strong>Rating:</strong> ${review.rating}</p>
                <p><strong>Comment:</strong> ${review.comment}</p>
                <p><strong>By:</strong> ${review.user.name}</p>
                <p><strong>Likes:</strong> ${review.likes.length}</p>
                <p><strong>Dislikes:</strong> ${review.dislikes.length}</p>
                <button onclick="likeReview('${review._id}')">Like</button>
                <button onclick="dislikeReview('${
                  review._id
                }')">Dislike</button>
                <button onclick="toggleReplyForm('${
                  review._id
                }')">Reply</button>
                <div id="reply-form-${review._id}" style="display: none;">
                  <form onsubmit="submitReply(event, '${review._id}')">
                    <label for="comment">Comment:</label>
                    <textarea name="comment" required></textarea><br><br>
                    <button type="submit">Submit Reply</button>
                  </form>
                </div>
                <div id="replies-${review._id}">
                  ${review.replies
                    .map(
                      (reply) => `
                    <div class="reply">
                      <p><strong>${reply.user.name}</strong></p>
                      <p>${reply.comment}</p>
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>
            `
                )
                .join("");
            }
          })
          .catch((error) => console.error("Error fetching reviews:", error));
      }

      function likeReview(reviewId) {
        interactWithReview(reviewId, "like");
      }

      function dislikeReview(reviewId) {
        interactWithReview(reviewId, "dislike");
      }

      function interactWithReview(reviewId, action) {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.error("No access token found in localStorage");
          return;
        }
        fetch(`http://127.0.0.1:5001/api/reviews/${reviewId}/interact`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${user.accessToken}`,
            "x-refresh-token": user.refreshToken,
          },
          body: JSON.stringify({ action }),
        })
          .then((response) => response.json())
          .then((review) => {
            fetchReviews(review.stall);
          })
          .catch((error) =>
            console.error("Error interacting with review:", error)
          );
      }

      function toggleReplyForm(reviewId) {
        const replyForm = document.getElementById(`reply-form-${reviewId}`);
        replyForm.style.display =
          replyForm.style.display === "none" ? "block" : "none";
      }

      function submitReply(event, reviewId) {
        event.preventDefault();
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.error("No access token found in localStorage");
          return;
        }

        const formData = new FormData(event.target);
        const data = {};
        formData.forEach((value, key) => (data[key] = value));

        fetch(`http://127.0.0.1:5001/api/reviews/${reviewId}/reply`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${user.accessToken}`,
            "x-refresh-token": user.refreshToken,
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((review) => {
            fetchReviews(review.stall);
          })
          .catch((error) => console.error("Error submitting reply:", error));
      }

      function submitReview(event) {
        event.preventDefault();
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user.accessToken) {
          console.error("No access token found in localStorage");
          return;
        }

        const formData = new FormData(event.target);
        const data = {};
        formData.forEach((value, key) => (data[key] = value));

        fetch("http://127.0.0.1:5001/api/reviews/create", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${user.accessToken}`,
            "x-refresh-token": user.refreshToken,
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((review) => {
            // Add the new review to the reviews list
            fetchReviews(data.stallId);
            toggleReviewForm(); // Hide the review form after submission
          })
          .catch((error) => console.error("Error submitting review:", error));
      }
    </script>
  </body>
</html>
