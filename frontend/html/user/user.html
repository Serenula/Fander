<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>
    <link rel="stylesheet" href="../../css/user.css" />
    <script src="../../js/config.js"></script>
    <script src="../../node_modules/htmx.org/dist/htmx.js"></script>
    <script src="../../js/adminCheck.js"></script>
  </head>
  <body>
    <h1>User Profile</h1>
    <div
      id="user-profile"
      hx-get="/user/profile"
      hx-trigger="load"
      hx-target="#user-profile"
      hx-swap="innerHTML"
      class="profile-info"
    >
      <!-- profile should be loaded here-->
    </div>
    <button onclick="toggleEditProfile()">Edit Profile</button>
    <button onclick="toggleChangePassword()">Change Password</button>

    <div id="edit-profile" style="display: none">
      <h2>Edit Profile</h2>
      <form
        id="edit-profile-form"
        hx-put="/user/edit"
        hx-target="#user-profile"
        hx-swap="outerHTML"
      >
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" /><br /><br />
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" /><br /><br />
        <button type="submit">Update Profile</button>
      </form>
    </div>

    <div id="change-password" style="display: none">
      <h2>Change Password</h2>
      <form
        id="change-password-form"
        hx-put="/user/change-password"
        hx-target="#user-profile"
        hx-swap="outerHTML"
      >
        <label for="current-password">Current Password:</label>
        <input
          type="password"
          id="current-password"
          name="current-password"
        /><br /><br />
        <label for="new-password">New Password:</label>
        <input
          type="password"
          id="new-password"
          name="new-password"
        /><br /><br />
        <label for="confirm-password">Confirm Password:</label>
        <input
          type="password"
          id="confirm-password"
          name="confirm-password"
        /><br /><br />
        <button type="submit">Change Password</button>
      </form>
    </div>
    <script>
      document.body.addEventListener("htmx:configRequest", (event) => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user && user.accessToken) {
          event.detail.headers["Authorization"] = `Bearer ${user.accessToken}`;
          event.detail.headers["x-refresh-token"] = user.refreshToken;
        }
      });

      function toggleEditProfile() {
        const editProfile = document.getElementById("edit-profile");
        editProfile.style.display =
          editProfile.style.display === "none" ? "block" : "none";
      }

      function togglePasswordVisibility() {
        const passwordField = document.getElementById("password");
        const checkbox = document.getElementById("show-password");

        if (checkbox.checked) {
          passwordField.type = "text";
        } else {
          passwordField.type = "password";
        }
      }

      function toggleChangePassword() {
        const changePassword = document.getElementById("change-password");
        changePassword.style.display =
          changePassword.style.display === "none" ? "block" : "none";
      }

      document.body.addEventListener("htmx:afterOnLoad", function (evt) {
        if (evt.detail.elt.id === "user-profile") {
          const user = JSON.parse(evt.detail.xhr.responseText);
          const profileDiv = document.getElementById("user-profile");
          profileDiv.innerHTML = `
            <p><strong></strong> ${user.name}</p>
            <p><strong></strong> ${user.email}</p>
          `;
        }
      });
    </script>
  </body>
</html>
