<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>
    <link rel="stylesheet" href="../../css/user.css" />
    <link rel="stylesheet" href="../../css/styles.css" />
    <script src="../../js/config.js"></script>
    <script src="../../node_modules/htmx.org/dist/htmx.js"></script>
    <script src="../../js/adminCheck.js"></script>
  </head>
  <body>
    <div id="navbar"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("user"));
        let navbarContent = `
          <nav>
            <ul>
              <li><button onclick="history.back()">Back</button></li>
              <li><a href="/html/stalls/stalls.html">Stalls</a></li>
        `;

        if (user) {
          navbarContent += `
            <li><a href="/html/user/user.html">User Profile</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
          `;
          if (user.role === "superAdmin") {
            navbarContent += `
              <li><a href="/html/admin/admin.html">Admin</a></li>
            `;
          }
        } else {
          navbarContent += `
            <li><a href="/html/auth/login.html">Login</a></li>
            <li><a href="/html/auth/register.html">Register</a></li>
          `;
        }

        navbarContent += `
            </ul>
          </nav>
        `;

        document.getElementById("navbar").innerHTML = navbarContent;
      });

      function logout() {
        localStorage.removeItem("user");
        window.location.href = "/html/auth/login.html";
      }
    </script>
    <h1>User Profile</h1>
    <div
      id="user-profile"
      hx-get="/user/profile"
      hx-trigger="load"
      hx-target="#user-profile"
      hx-swap="innerHTML"
      class="profile-info"
    >
      <!-- profile should be loaded here-->
    </div>
    <button onclick="toggleEditProfile()">Edit Profile</button>
    <button onclick="toggleChangePassword()">Change Password</button>

    <div id="edit-profile" style="display: none">
      <h2>Edit Profile</h2>
      <form
        id="edit-profile-form"
        hx-put="/user/edit"
        hx-target="#user-profile"
        hx-swap="innerHTML"
      >
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" /><br /><br />
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" /><br /><br />
        <button type="submit">Update Profile</button>
      </form>
    </div>

    <div id="change-password" style="display: none">
      <h2>Change Password</h2>
      <form
        id="change-password-form"
        hx-put="/user/change-password"
        hx-target="#user-profile"
        hx-swap="innerHTML"
      >
        <label for="current-password">Current Password:</label>
        <input
          type="password"
          id="current-password"
          name="current-password"
        /><br /><br />
        <label for="new-password">New Password:</label>
        <input
          type="password"
          id="new-password"
          name="new-password"
        /><br /><br />
        <label for="confirm-password">Confirm Password:</label>
        <input
          type="password"
          id="confirm-password"
          name="confirm-password"
        /><br /><br />
        <button type="submit">Change Password</button>
      </form>
    </div>
    <a href="/html/legal/termsofuse.html"><strong>Terms of Use</strong></a
    ><br />
    <a href="https://forms.gle/jv5Dn4ALpJUfpc4W9"
      ><strong>Submit a Stall</strong></a
    >
    <script>
      document.body.addEventListener("htmx:configRequest", (event) => {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user && user.accessToken) {
          event.detail.headers["Authorization"] = `Bearer ${user.accessToken}`;
          event.detail.headers["x-refresh-token"] = user.refreshToken;
        }
      });

      function toggleEditProfile() {
        const editProfile = document.getElementById("edit-profile");
        editProfile.style.display =
          editProfile.style.display === "none" ? "block" : "none";
      }

      function toggleChangePassword() {
        const changePassword = document.getElementById("change-password");
        changePassword.style.display =
          changePassword.style.display === "none" ? "block" : "none";
      }

      document.body.addEventListener("htmx:afterSwap", function (evt) {
        if (evt.detail.elt.id === "user-profile") {
          try {
            const user = JSON.parse(evt.detail.xhr.responseText);
            if (user && user.name && user.email) {
              const profileDiv = document.getElementById("user-profile");
              profileDiv.innerHTML = `
                <p><strong>Name:</strong> ${user.name}</p>
                <p><strong>Email:</strong> ${user.email}</p>
              `;
            } else {
              console.error("Invalid user data:", user);
              document.getElementById("user-profile").innerHTML =
                "<p>Error loading profile information.</p>";
            }
          } catch (error) {
            console.error("Error parsing response:", error);
            document.getElementById("user-profile").innerHTML =
              "<p>Error loading profile information.</p>";
          }
        }
      });
    </script>
  </body>
</html>
